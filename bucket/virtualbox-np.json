{
    "version": "7.2.6a-172322",
    "description": "Powerful x86 and AMD64/Intel64 virtualization product for enterprise as well as home use.",
    "homepage": "https://www.virtualbox.org",
    "license": {
        "identifier": "GPL-3.0-only",
        "url": "https://www.virtualbox.org/wiki/Licensing_FAQ"
    },
    "depends": "extras/vcredist2022",
    "architecture": {
        "64bit": {
            "url": "https://download.virtualbox.org/virtualbox/7.2.6/VirtualBox-7.2.6a-172322-Win.exe",
            "hash": "15c18780b9a76ff6d5a2dbfe016992e0aea631bf25ffc05a11080bb0ed49a690"
        }
    },
    "pre_install": [
        "if (-not (is_admin)) { abort \"`n[ERROR]  $app requires admin rights to $cmd.\" }",
        "$extract_args = @('-extract', '-path', \"$dir\\tmp\", '-silent')",
        "$extract_status = Invoke-ExternalCommand -FilePath \"$dir\\$fname\" -ArgumentList $extract_args",
        "if (-not $extract_status) { abort \"`n[ERROR] Unable to unpack '$dir\\$fname'.\" }",
        "Remove-Item -Path \"$dir\\$fname\" -Force -ErrorAction SilentlyContinue"
    ],
    "installer": {
        "script": [
            "$installer_file = Get-ChildItem -Path \"$dir\\tmp\" -Filter '*.msi' -File | Select-Object -ExpandProperty FullName -First 1",
            "if (-not $installer_file) { abort \"`n[ERROR] MSI package not found in extraction buffer.\" }",
            "$install_args = @(",
            "    '/i', $installer_file,",
            "    '/qn', '/norestart',",
            "    'VBOX_INSTALLDESKTOPSHORTCUT=0', 'VBOX_INSTALLQUICKLAUNCHSHORTCUT=0', 'VBOX_START=0', 'VBOX_INSTALLSTARTMENUENTRIES=0',",
            "    'ALLUSERS=1'",
            ")",
            "$deploy_status = Invoke-ExternalCommand -FilePath 'msiexec.exe' -ArgumentList $install_args -LogPath \"$dir\\install.log\"",
            "if (-not $deploy_status) {",
            "    Select-String -Path \"$dir\\install.log\" -Pattern 'MSI\\s*\\(.*' | ForEach-Object { warn \"Log Trace: $($_.Line)\" }",
            "    abort \"Installation Failed: Exit code indicates a deployment failure.`nReference Log: '$dir\\install.log'.\"",
            "}",
            "Remove-Item -Path \"$dir\\tmp\", \"$dir\\install.log\" -Recurse -Force -ErrorAction SilentlyContinue"
        ]
    },
    "post_install": [
        "$install_dir = \"$env:ProgramW6432\\Oracle\\VirtualBox\"",
        "startmenu_shortcut \"$install_dir\\VirtualBox.exe\" 'VirtualBox' $null $null $global",
        "Get-ChildItem -Path $install_dir -Filter '*.exe' -File | ForEach-Object {",
        "   Write-Host \"Creating shim '$($_.BaseName)'.\"",
        "   shim $_.FullName $global $_.BaseName",
        "}"
    ],
    "pre_uninstall": [
        "if (-not (is_admin)) { abort \"`n[ERROR] $app requires admin rights to $cmd\" }",
        "Remove-Item -Path \"$(shortcut_folder $global)\\VirtualBox.lnk\" -Force -ErrorAction SilentlyContinue",
        "$install_dir = \"$env:ProgramW6432\\Oracle\\VirtualBox\"",
        "if (-not (Test-Path $install_dir)) { abort \"`n[ERROR] Could not locate the install folder at '$install_dir'\" }",
        "Get-ChildItem -Path $install_dir -Filter '*.exe' -File | ForEach-Object {",
        "    rm_shim $_.BaseName \"$(shimdir $global)\"",
        "}"
    ],
    "uninstaller": {
        "script": [
            "$product_id = Get-CimInstance Win32_Product | Where-Object { $_.Name -match 'Oracle VirtualBox [\\d\\.]+' } | Select-Object -ExpandProperty IdentifyingNumber -First 1",
            "if (-not $product_id) { abort \"`n[ERROR] Could not locate the product identity for Oracle VirtualBox.\" }",
            "$removal_args = @('/x', $product_id, '/qn', '/norestart')",
            "$removal_status = Invoke-ExternalCommand -FilePath 'msiexec.exe' -ArgumentList $removal_args -LogPath \"$dir\\uninstall.log\"",
            "if(-not $removal_status) { abort \"`n[ERROR] Process did not complete.`nLog: '$dir\\uninstall.log'.\" }",
            "Remove-Item -Path \"$dir\\uninstall.log\" -Force -ErrorAction SilentlyContinue"
        ]
    },
    "checkver": {
        "url": "https://www.virtualbox.org/wiki/Downloads",
        "regex": "VirtualBox-([\\w.-]+)-Win.exe"
    },
    "autoupdate": {
        "architecture": {
            "64bit": {
                "url": "https://download.virtualbox.org/virtualbox/$matchHead/VirtualBox-$version-Win.exe"
            }
        },
        "hash": {
            "url": "https://download.virtualbox.org/virtualbox/$matchHead/SHA256SUMS"
        }
    }
}
